<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RFH | AI Coach</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Roboto:wght@300;400;500&display=swap"
        rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        body,
        html {
            height: 100%;
        }

        .chat-container {
            height: calc(100vh - 76px);
            /* Adjust for navbar */
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 2rem;
            padding-bottom: 6rem;
            /* Extra padding at bottom for input area */
        }

        .chat-input-area {
            padding: 1.5rem 2rem;
            background-color: #0a0a0a;
            border-top: 2px solid #333;
            position: sticky;
            bottom: 0;
            z-index: 10;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
        }

        .scroll-hint {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(208, 0, 0, 0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            animation: bounceHint 2s ease-in-out infinite;
            pointer-events: none;
            z-index: 5;
            white-space: nowrap;
        }

        .scroll-hint::after {
            content: '↓';
            display: inline-block;
            margin-left: 0.5rem;
            animation: bounceArrow 1s ease-in-out infinite;
        }

        @keyframes bounceHint {

            0%,
            100% {
                transform: translateX(-50%) translateY(0);
                opacity: 0.8;
            }

            50% {
                transform: translateX(-50%) translateY(-10px);
                opacity: 1;
            }
        }

        @keyframes bounceArrow {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(5px);
            }
        }

        .scroll-hint.hidden {
            display: none;
        }

        .message {
            max-width: 80%;
            margin-bottom: 1.5rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            line-height: 1.5;
            animation: messageSlideIn 0.3s ease-out;
        }

        .message.user {
            background-color: #333;
            color: #fff;
            margin-left: auto;
            border-bottom-right-radius: 0;
        }

        .message.ai {
            background-color: #d00000;
            color: #fff;
            margin-right: auto;
            border-bottom-left-radius: 0;
        }

        .typing-indicator {
            display: none;
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        @media (max-width: 768px) {
            .chat-container {
                height: calc(100dvh - 70px);
                /* Use dvh for better mobile support */
            }

            /* Hide footer on mobile to prevent clutter and scrolling issues */
            #footer-placeholder {
                display: none !important;
            }

            .chat-history {
                padding: 1rem !important;
                padding-bottom: 8rem !important;
                /* Increased padding for input area */
            }

            .message {
                max-width: 85% !important;
                padding: 0.875rem 1rem !important;
                font-size: 0.9rem !important;
                margin-bottom: 1rem !important;
            }

            .chat-input-area {
                padding: 0.75rem !important;
                position: fixed;
                /* Fixed position to prevent jumping */
                bottom: 0;
                left: 0;
                right: 0;
                background-color: #0a0a0a;
                border-top: 2px solid #333;
                box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.8);
            }

            .chat-input-area .form-control {
                padding: 0.75rem !important;
                font-size: 16px;
                /* Prevent zoom on iOS */
            }

            .chat-input-area .btn {
                padding: 0.75rem 1rem !important;
                font-size: 0.875rem;
            }

            .scroll-hint {
                bottom: 85px;
                font-size: 0.75rem;
                padding: 0.4rem 0.8rem;
            }
        }
    </style>
</head>

<body class="bg-black text-light">

    <!-- Header Component -->
    <div id="header-placeholder"></div>

    <!-- Chat Interface -->
    <div class="container-fluid p-0 chat-container">
        <div class="chat-history" id="chatHistory">
            <div class="message ai">
                <strong>Coach:</strong> Welcome. I am your Relationship Strategist. I don't offer comforting lies, only
                effective tactics. What is your current situation?
            </div>
        </div>
        <div class="scroll-hint" id="scrollHint">Scroll down to type your message</div>
        <div class="typing-indicator px-4" id="typingIndicator">Coach is analyzing...</div>

        <div class="chat-input-area">
            <!-- Gender Toggle - Inside fixed input area -->
            <div class="pb-3" id="genderToggleContainer" style="display: none;">
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="genderPreference" id="maleCoach" value="male" checked>
                    <label class="btn btn-outline-primary" for="maleCoach">Coach for Men</label>

                    <input type="radio" class="btn-check" name="genderPreference" id="femaleCoach" value="female">
                    <label class="btn btn-outline-danger" for="femaleCoach">Coach for Women</label>
                </div>
            </div>

            <form id="chatForm" class="d-flex gap-2">
                <input type="text" id="userInput"
                    class="form-control form-control-lg bg-dark text-white border-secondary rounded-0"
                    placeholder="Describe your situation..." required autocomplete="off">
                <button type="submit" class="btn btn-danger btn-lg rounded-0 px-4 fw-bold">SEND</button>

                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-lg rounded-0" type="button" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        &#8942;
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark">
                        <li><a class="dropdown-item text-danger" href="#" id="clearHistoryOption">Clear Chat History</a>
                        </li>
                    </ul>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer Component -->
    <div id="footer-placeholder"></div>

    <script src="js/components.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
    <script src="js/navbar.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/config.js"></script>
    <script>
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');
        const chatHistory = document.getElementById('chatHistory');
        const typingIndicator = document.getElementById('typingIndicator');
        const scrollHint = document.getElementById('scrollHint');

        // Handle scroll hint visibility
        function checkScrollHint() {
            const isNearBottom = chatHistory.scrollHeight - chatHistory.scrollTop - chatHistory.clientHeight < 150;
            if (isNearBottom || userInput.value.length > 0) {
                scrollHint.classList.add('hidden');
            } else {
                scrollHint.classList.remove('hidden');
            }
        }

        // Check on scroll
        chatHistory.addEventListener('scroll', checkScrollHint);

        // Check on input
        userInput.addEventListener('input', checkScrollHint);

        // Check on focus
        userInput.addEventListener('focus', () => {
            scrollHint.classList.add('hidden');
        });

        // Initial check
        setTimeout(checkScrollHint, 500);

        // Load chat history
        async function loadChatHistory(gender = null) {
            const token = localStorage.getItem('access_token');

            // Determine gender to load (default to current selection if not provided)
            if (!gender) {
                if (token) {
                    // For logged-in, we'll fetch user preference first or just default to male
                    // But usually we want to load based on what's selected in UI
                    gender = document.querySelector('input[name="genderPreference"]:checked')?.value || 'male';
                } else {
                    gender = localStorage.getItem('guest_gender_preference') || 'male';
                }
            }

            if (!token) {
                // Guest user - load from localStorage based on gender
                const storageKey = `guest_chat_history_${gender}`;
                const guestHistory = localStorage.getItem(storageKey);

                chatHistory.innerHTML = ''; // Clear current view

                if (guestHistory) {
                    try {
                        const messages = JSON.parse(guestHistory);
                        if (messages.length > 0) {
                            messages.forEach(msg => {
                                appendMessage(msg.sender, msg.content, false); // false = don't save again
                            });
                        } else {
                            showWelcomeMessage(gender);
                        }
                    } catch (error) {
                        console.error('Error loading guest history:', error);
                        showWelcomeMessage(gender);
                    }
                } else {
                    showWelcomeMessage(gender);
                }

                // Scroll to bottom
                setTimeout(() => {
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                }, 100);
                return;
            }

            // Logged-in user - load from server with coach_type filter
            try {
                const response = await fetch(`${API_BASE_URL}/chat/history?coach_type=${gender}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    chatHistory.innerHTML = ''; // Clear current view

                    if (data.messages.length > 0) {
                        data.messages.forEach(msg => {
                            // Map role 'assistant' to 'ai' for CSS class
                            const sender = msg.role === 'assistant' ? 'ai' : 'user';
                            appendMessage(sender, msg.content, false); // false = don't save again
                        });
                    } else {
                        showWelcomeMessage(gender);
                    }

                    // Scroll to bottom
                    setTimeout(() => {
                        chatHistory.scrollTop = chatHistory.scrollHeight;
                    }, 100);
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        function showWelcomeMessage(gender) {
            const message = gender === 'male'
                ? "Welcome. I am your Relationship Strategist. I don't offer comforting lies, only effective tactics. What is your current situation?"
                : "Welcome. I am your Relationship Guide. I'm here to help you decode his behavior and find clarity. What's on your mind?";

            chatHistory.innerHTML = `
                <div class="message ai">
                    <strong>Coach:</strong> ${message}
                </div>
            `;
        }

        loadChatHistory();

        // Auto-scroll to bottom on page load to show toggle and input box
        setTimeout(() => {
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }, 100);

        // Check for token and guest query count
        const token = localStorage.getItem('access_token');
        const isGuest = !token;
        let guestQueryCount = parseInt(localStorage.getItem('guest_query_count') || '0');
        const GUEST_QUERY_LIMIT = 5;

        // Gender preference toggle
        const genderToggleContainer = document.getElementById('genderToggleContainer');
        const maleCoachRadio = document.getElementById('maleCoach');
        const femaleCoachRadio = document.getElementById('femaleCoach');

        genderToggleContainer.style.display = 'block';

        if (!isGuest) {
            // Logged-in user - load from server and save to server
            async function loadGenderPreference() {
                try {
                    const response = await fetch(`${API_BASE_URL}/users/me`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const userData = await response.json();
                        if (userData.gender_preference === 'female') {
                            femaleCoachRadio.checked = true;
                        } else {
                            maleCoachRadio.checked = true;
                        }
                    }
                } catch (error) {
                    console.error('Error loading gender preference:', error);
                }
            }

            loadGenderPreference();

            // Handle gender preference change
            async function updateGenderPreference(gender) {
                try {
                    const response = await fetch(`${API_BASE_URL}/update-profile`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ gender_preference: gender })
                    });

                    if (response.ok) {
                        console.log(`Gender preference updated to: ${gender}`);
                        // Reload chat history for the new coach type
                        loadChatHistory(gender);
                    }
                } catch (error) {
                    console.error('Error updating gender preference:', error);
                }
            }

            maleCoachRadio.addEventListener('change', () => {
                if (maleCoachRadio.checked) {
                    updateGenderPreference('male');
                }
            });

            femaleCoachRadio.addEventListener('change', () => {
                if (femaleCoachRadio.checked) {
                    updateGenderPreference('female');
                }
            });
        } else {
            // Guest user - load from localStorage and save to localStorage
            const savedGenderPreference = localStorage.getItem('guest_gender_preference') || 'male';
            if (savedGenderPreference === 'female') {
                femaleCoachRadio.checked = true;
            } else {
                maleCoachRadio.checked = true;
            }

            function updateGuestGenderPreference(gender) {
                localStorage.setItem('guest_gender_preference', gender);
                console.log(`Guest gender preference updated to: ${gender}`);
                // Reload chat history for the new coach type
                loadChatHistory(gender);
            }

            maleCoachRadio.addEventListener('change', () => {
                if (maleCoachRadio.checked) {
                    updateGuestGenderPreference('male');
                }
            });

            femaleCoachRadio.addEventListener('change', () => {
                if (femaleCoachRadio.checked) {
                    updateGuestGenderPreference('female');
                }
            });
        }

        // Clear history button logic
        const clearHistoryOption = document.getElementById('clearHistoryOption');

        if (clearHistoryOption) {
            clearHistoryOption.addEventListener('click', async (e) => {
                e.preventDefault();

                if (!confirm('Are you sure you want to clear your chat history? This cannot be undone.')) {
                    return;
                }

                const gender = document.querySelector('input[name="genderPreference"]:checked')?.value || 'male';

                if (isGuest) {
                    // Clear guest history
                    const storageKey = `guest_chat_history_${gender}`;
                    localStorage.removeItem(storageKey);
                    chatHistory.innerHTML = '';
                    showWelcomeMessage(gender);
                    if (typeof showToast === 'function') showToast('Chat history cleared.', 'success');
                } else {
                    // Clear logged-in user history
                    try {
                        const response = await fetch(`${API_BASE_URL}/chat/history?coach_type=${gender}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            chatHistory.innerHTML = '';
                            showWelcomeMessage(gender);
                            if (typeof showToast === 'function') showToast('Chat history cleared.', 'success');
                        } else {
                            if (typeof showToast === 'function') showToast('Failed to clear history.', 'error');
                        }
                    } catch (error) {
                        console.error('Error clearing history:', error);
                        if (typeof showToast === 'function') showToast('Error clearing history.', 'error');
                    }
                }
            });
        }

        // Show guest status in initial message if applicable
        if (isGuest) {
            const queriesLeft = GUEST_QUERY_LIMIT - guestQueryCount;
            if (queriesLeft > 0) {
                appendMessage('ai', `You have ${queriesLeft} free queries remaining. Sign up to get more!`);
            }
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (!message) return;

            // Check guest query limit
            if (isGuest) {
                if (guestQueryCount >= GUEST_QUERY_LIMIT) {
                    showToast('You\'ve used all 5 free queries! Please sign up or log in to continue.', 'warning');
                    setTimeout(() => window.location.href = 'signup.html', 2000);
                    return;
                }
            }

            // Add user message
            appendMessage('user', message);
            userInput.value = '';

            // Show typing indicator
            typingIndicator.style.display = 'block';
            chatHistory.scrollTop = chatHistory.scrollHeight;

            try {
                let endpoint, headers, body;

                if (isGuest) {
                    // Guest endpoint - include gender preference and conversation history
                    const guestGenderPreference = localStorage.getItem('guest_gender_preference') || 'male';
                    const storageKey = `guest_chat_history_${guestGenderPreference}`;
                    const guestHistory = localStorage.getItem(storageKey);

                    // Build history array (limit to last 20 messages for performance)
                    let history = [];
                    if (guestHistory) {
                        try {
                            const messages = JSON.parse(guestHistory);
                            // Take last 20 messages and format for API
                            history = messages.slice(-20).map(msg => ({
                                role: msg.sender === 'user' ? 'user' : 'assistant',
                                content: msg.content
                            }));
                        } catch (error) {
                            console.error('Error parsing guest history:', error);
                        }
                    }

                    endpoint = `${API_BASE_URL}/guest-chat`;
                    headers = { 'Content-Type': 'application/json' };
                    body = JSON.stringify({
                        message: message,
                        gender_preference: guestGenderPreference,
                        history: history
                    });
                } else {
                    // Authenticated endpoint
                    endpoint = `${API_BASE_URL}/chat`;
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    };
                    body = JSON.stringify({ message: message });
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: body,
                    keepalive: true  // Ensures request continues even if tab is switched
                });

                if (response.status === 401) {
                    showToast('Session expired. Please login again.', 'error');
                    localStorage.removeItem('access_token');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                    return;
                }

                if (response.status === 403) {
                    const error = await response.json();
                    showToast(error.detail, 'warning');
                    setTimeout(() => window.location.href = 'profile.html', 2000);
                    return;
                }

                const data = await response.json();

                // Increment guest query count
                if (isGuest) {
                    guestQueryCount++;
                    localStorage.setItem('guest_query_count', guestQueryCount.toString());

                    const queriesLeft = GUEST_QUERY_LIMIT - guestQueryCount;
                    if (queriesLeft > 0) {
                        appendMessage('ai', data.response + `\n\n(${queriesLeft} free queries remaining)`);
                    } else {
                        appendMessage('ai', data.response + '\n\nThat was your last free query! Sign up to continue.');
                    }
                } else {
                    appendMessage('ai', data.response);
                }

                // Hide typing indicator
                typingIndicator.style.display = 'none';

            } catch (error) {
                console.error('Error:', error);
                typingIndicator.style.display = 'none';
                appendMessage('ai', 'Connection lost. The matrix is interfering. Try again.');
            }
        });

        // Format text with paragraph breaks and bullet points
        function formatText(text) {
            // Escape HTML to prevent XSS
            const escapeHtml = (unsafe) => {
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;");
            };

            let formatted = escapeHtml(text);

            // Helper to parse inline markdown
            const parseInline = (str) => {
                return str
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>');
            };

            // Split into lines
            let lines = formatted.split('\n');
            let html = '';
            let inBulletList = false;

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i].trim();

                if (line === '') {
                    // Empty line = paragraph break
                    if (inBulletList) {
                        html += '</ul>';
                        inBulletList = false;
                    }
                    html += '<br>';
                } else {
                    // Check for bullet points
                    // We check for '* ' (asterisk space) to distinguish from italics
                    let isBullet = line.startsWith('-') || line.startsWith('•') || line.startsWith('* ');

                    if (isBullet) {
                        // Bullet point
                        if (!inBulletList) {
                            html += '<ul style="margin: 8px 0; padding-left: 20px;">';
                            inBulletList = true;
                        }
                        let content = line.substring(1).trim();
                        content = parseInline(content);
                        html += '<li style="margin: 4px 0;">' + content + '</li>';
                    } else {
                        // Regular text
                        if (inBulletList) {
                            html += '</ul>';
                            inBulletList = false;
                        }
                        let content = parseInline(line);
                        html += content + '<br>';
                    }
                }
            }

            // Close any open bullet list
            if (inBulletList) {
                html += '</ul>';
            }

            return html;
        }

        function appendMessage(sender, text, save = true) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);

            // Add strong tag for sender name
            const senderName = sender === 'user' ? 'You' : 'Coach';

            // Format AI responses with proper HTML
            const formattedText = sender === 'ai' ? formatText(text) : text.replace(/\n/g, '<br>');

            messageDiv.innerHTML = `<strong>${senderName}:</strong> ${formattedText}`;

            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            // Only save to localStorage for guest users if save is true
            // IMPORTANT: Check isGuest variable, not just token presence
            if (isGuest && save) {
                saveGuestMessage(sender, text);
            }
            // For logged-in users, messages are saved server-side via API
        }

        // Save guest message to localStorage with proper gender separation
        function saveGuestMessage(sender, content) {
            try {
                // Get the CURRENT gender preference for proper storage key
                const gender = localStorage.getItem('guest_gender_preference') || 'male';
                const storageKey = `guest_chat_history_${gender}`;

                const guestHistory = localStorage.getItem(storageKey);
                let messages = guestHistory ? JSON.parse(guestHistory) : [];

                messages.push({ sender, content });

                // Keep only last 50 messages to avoid localStorage size limits
                if (messages.length > 50) {
                    messages = messages.slice(-50);
                }

                localStorage.setItem(storageKey, JSON.stringify(messages));
                console.log(`Saved message to ${storageKey}:`, { sender, content });
            } catch (error) {
                console.error('Error saving guest message:', error);
            }
        }
    </script>
</body>

</html>