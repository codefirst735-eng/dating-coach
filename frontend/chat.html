<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RFH | AI Coach</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Roboto:wght@300;400;500&display=swap"
        rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        body,
        html {
            height: 100%;
        }

        .chat-container {
            height: calc(100vh - 76px);
            /* Adjust for navbar */
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 2rem;
            padding-bottom: 6rem;
            /* Extra padding at bottom for input area */
        }

        .chat-input-area {
            padding: 1.5rem 2rem;
            background-color: #0a0a0a;
            border-top: 2px solid #333;
            position: sticky;
            bottom: 0;
            z-index: 10;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
        }

        .scroll-hint {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(208, 0, 0, 0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            animation: bounceHint 2s ease-in-out infinite;
            pointer-events: none;
            z-index: 5;
            white-space: nowrap;
        }

        .scroll-hint::after {
            content: 'â†“';
            display: inline-block;
            margin-left: 0.5rem;
            animation: bounceArrow 1s ease-in-out infinite;
        }

        @keyframes bounceHint {

            0%,
            100% {
                transform: translateX(-50%) translateY(0);
                opacity: 0.8;
            }

            50% {
                transform: translateX(-50%) translateY(-10px);
                opacity: 1;
            }
        }

        @keyframes bounceArrow {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(5px);
            }
        }

        .scroll-hint.hidden {
            display: none;
        }

        .message {
            max-width: 80%;
            margin-bottom: 1.5rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            font-size: 1rem;
            line-height: 1.5;
            animation: messageSlideIn 0.3s ease-out;
        }

        .message.user {
            background-color: #333;
            color: #fff;
            margin-left: auto;
            border-bottom-right-radius: 0;
        }

        .message.ai {
            background-color: #d00000;
            color: #fff;
            margin-right: auto;
            border-bottom-left-radius: 0;
        }

        .typing-indicator {
            display: none;
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        @media (max-width: 768px) {
            .chat-container {
                height: calc(100vh - 70px);
            }

            .chat-history {
                padding: 1rem !important;
                padding-bottom: 7rem !important;
                /* Extra padding for mobile to ensure input is visible */
            }

            .message {
                max-width: 85% !important;
                padding: 0.875rem 1rem !important;
                font-size: 0.9rem !important;
                margin-bottom: 1rem !important;
            }

            .chat-input-area {
                padding: 1rem !important;
                position: sticky;
                bottom: 0;
                background-color: #0a0a0a;
                border-top: 2px solid #333;
                box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.8);
            }

            .chat-input-area .form-control {
                padding: 0.75rem !important;
                font-size: 0.95rem;
            }

            .chat-input-area .btn {
                padding: 0.75rem 1.25rem !important;
                font-size: 0.875rem;
            }

            .scroll-hint {
                bottom: 70px;
                font-size: 0.75rem;
                padding: 0.4rem 0.8rem;
            }
        }
    </style>
</head>

<body class="bg-black text-light">

    <!-- Header Component -->
    <div id="header-placeholder"></div>

    <!-- Chat Interface -->
    <div class="container-fluid p-0 chat-container">
        <div class="chat-history" id="chatHistory">
            <div class="message ai">
                <strong>Coach:</strong> Welcome. I am your Relationship Strategist. I don't offer comforting lies, only
                effective tactics. What is your current situation?
            </div>
        </div>
        <div class="scroll-hint" id="scrollHint">Scroll down to type your message</div>
        <div class="typing-indicator px-4" id="typingIndicator">Coach is analyzing...</div>

        <div class="chat-input-area">
            <!-- Gender Toggle - Inside fixed input area -->
            <div class="pb-3" id="genderToggleContainer" style="display: none;">
                <div class="btn-group w-100" role="group">
                    <input type="radio" class="btn-check" name="genderPreference" id="maleCoach" value="male" checked>
                    <label class="btn btn-outline-primary" for="maleCoach">Coach for Men</label>

                    <input type="radio" class="btn-check" name="genderPreference" id="femaleCoach" value="female">
                    <label class="btn btn-outline-danger" for="femaleCoach">Coach for Women</label>
                </div>
            </div>

            <form id="chatForm" class="d-flex gap-3">
                <input type="text" id="userInput"
                    class="form-control form-control-lg bg-dark text-white border-secondary rounded-0"
                    placeholder="Describe your situation..." required autocomplete="off">
                <button type="submit" class="btn btn-danger btn-lg rounded-0 px-4 fw-bold">SEND</button>
            </form>
        </div>
    </div>

    <!-- Footer Component -->
    <div id="footer-placeholder"></div>

    <script src="js/components.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
    <script src="js/navbar.js"></script>
    <script src="js/toast.js"></script>
    <script>
        const chatForm = document.getElementById('chatForm');
        const userInput = document.getElementById('userInput');
        const chatHistory = document.getElementById('chatHistory');
        const typingIndicator = document.getElementById('typingIndicator');
        const scrollHint = document.getElementById('scrollHint');

        // Handle scroll hint visibility
        function checkScrollHint() {
            const isNearBottom = chatHistory.scrollHeight - chatHistory.scrollTop - chatHistory.clientHeight < 150;
            if (isNearBottom || userInput.value.length > 0) {
                scrollHint.classList.add('hidden');
            } else {
                scrollHint.classList.remove('hidden');
            }
        }

        // Check on scroll
        chatHistory.addEventListener('scroll', checkScrollHint);

        // Check on input
        userInput.addEventListener('input', checkScrollHint);

        // Check on focus
        userInput.addEventListener('focus', () => {
            scrollHint.classList.add('hidden');
        });

        // Initial check
        setTimeout(checkScrollHint, 500);

        // Load chat history
        async function loadChatHistory() {
            const token = localStorage.getItem('access_token');

            if (!token) {
                // Guest user - load from localStorage
                const guestHistory = localStorage.getItem('guest_chat_history');
                if (guestHistory) {
                    try {
                        const messages = JSON.parse(guestHistory);
                        if (messages.length > 0) {
                            chatHistory.innerHTML = '';
                            messages.forEach(msg => {
                                appendMessage(msg.sender, msg.content);
                            });
                        }
                    } catch (error) {
                        console.error('Error loading guest history:', error);
                    }
                }
                return;
            }

            // Logged-in user - load from server
            try {
                const response = await fetch('https://dating-coach-ytos.onrender.com/chat/history', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    // Clear default welcome message if history exists
                    if (data.messages.length > 0) {
                        chatHistory.innerHTML = '';
                        data.messages.forEach(msg => {
                            // Map role 'assistant' to 'ai' for CSS class
                            const sender = msg.role === 'assistant' ? 'ai' : 'user';
                            appendMessage(sender, msg.content);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        loadChatHistory();

        // Auto-scroll to bottom on page load to show toggle and input box
        setTimeout(() => {
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }, 100);

        // Check for token and guest query count
        const token = localStorage.getItem('access_token');
        const isGuest = !token;
        let guestQueryCount = parseInt(localStorage.getItem('guest_query_count') || '0');
        const GUEST_QUERY_LIMIT = 5;

        // Gender preference toggle
        const genderToggleContainer = document.getElementById('genderToggleContainer');
        const maleCoachRadio = document.getElementById('maleCoach');
        const femaleCoachRadio = document.getElementById('femaleCoach');

        genderToggleContainer.style.display = 'block';

        if (!isGuest) {
            // Logged-in user - load from server and save to server
            async function loadGenderPreference() {
                try {
                    const response = await fetch('https://dating-coach-ytos.onrender.com/users/me', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        const userData = await response.json();
                        if (userData.gender_preference === 'female') {
                            femaleCoachRadio.checked = true;
                        } else {
                            maleCoachRadio.checked = true;
                        }
                    }
                } catch (error) {
                    console.error('Error loading gender preference:', error);
                }
            }

            loadGenderPreference();

            // Handle gender preference change
            async function updateGenderPreference(gender) {
                try {
                    const response = await fetch('https://dating-coach-ytos.onrender.com/update-profile', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ gender_preference: gender })
                    });

                    if (response.ok) {
                        console.log(`Gender preference updated to: ${gender}`);
                        chatHistory.innerHTML = `
                            <div class="message ai">
                                <strong>Coach:</strong> Welcome. I'm your ${gender === 'male' ? 'Coach for Men' : 'Coach for Women'}. How can I help you today?
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('Error updating gender preference:', error);
                }
            }

            maleCoachRadio.addEventListener('change', () => {
                if (maleCoachRadio.checked) {
                    updateGenderPreference('male');
                }
            });

            femaleCoachRadio.addEventListener('change', () => {
                if (femaleCoachRadio.checked) {
                    updateGenderPreference('female');
                }
            });
        } else {
            // Guest user - load from localStorage and save to localStorage
            const savedGenderPreference = localStorage.getItem('guest_gender_preference') || 'male';
            if (savedGenderPreference === 'female') {
                femaleCoachRadio.checked = true;
            } else {
                maleCoachRadio.checked = true;
            }

            function updateGuestGenderPreference(gender) {
                localStorage.setItem('guest_gender_preference', gender);
                console.log(`Guest gender preference updated to: ${gender}`);

                // Clear chat history when switching coaches
                localStorage.removeItem('guest_chat_history');

                chatHistory.innerHTML = `
                    <div class="message ai">
                        <strong>Coach:</strong> Welcome. I'm your ${gender === 'male' ? 'Coach for Men' : 'Coach for Women'}. How can I help you today?
                    </div>
                `;
            }

            maleCoachRadio.addEventListener('change', () => {
                if (maleCoachRadio.checked) {
                    updateGuestGenderPreference('male');
                }
            });

            femaleCoachRadio.addEventListener('change', () => {
                if (femaleCoachRadio.checked) {
                    updateGuestGenderPreference('female');
                }
            });
        }

        // Show guest status in initial message if applicable
        if (isGuest) {
            const queriesLeft = GUEST_QUERY_LIMIT - guestQueryCount;
            if (queriesLeft > 0) {
                appendMessage('ai', `You have ${queriesLeft} free queries remaining. Sign up to get more!`);
            }
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (!message) return;

            // Check guest query limit
            if (isGuest) {
                if (guestQueryCount >= GUEST_QUERY_LIMIT) {
                    showToast('You\'ve used all 5 free queries! Please sign up or log in to continue.', 'warning');
                    setTimeout(() => window.location.href = 'signup.html', 2000);
                    return;
                }
            }

            // Add user message
            appendMessage('user', message);
            userInput.value = '';

            // Show typing indicator
            typingIndicator.style.display = 'block';
            chatHistory.scrollTop = chatHistory.scrollHeight;

            try {
                let endpoint, headers, body;

                if (isGuest) {
                    // Guest endpoint - include gender preference
                    const guestGenderPreference = localStorage.getItem('guest_gender_preference') || 'male';
                    endpoint = 'https://dating-coach-ytos.onrender.com/guest-chat';
                    headers = { 'Content-Type': 'application/json' };
                    body = JSON.stringify({
                        message: message,
                        gender_preference: guestGenderPreference
                    });
                } else {
                    // Authenticated endpoint
                    endpoint = 'https://dating-coach-ytos.onrender.com/chat';
                    headers = {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    };
                    body = JSON.stringify({ message: message });
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: body,
                });

                if (response.status === 401) {
                    showToast('Session expired. Please login again.', 'error');
                    localStorage.removeItem('access_token');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                    return;
                }

                if (response.status === 403) {
                    const error = await response.json();
                    showToast(error.detail, 'warning');
                    setTimeout(() => window.location.href = 'profile.html', 2000);
                    return;
                }

                const data = await response.json();

                // Increment guest query count
                if (isGuest) {
                    guestQueryCount++;
                    localStorage.setItem('guest_query_count', guestQueryCount.toString());

                    const queriesLeft = GUEST_QUERY_LIMIT - guestQueryCount;
                    if (queriesLeft > 0) {
                        appendMessage('ai', data.response + `\n\n(${queriesLeft} free queries remaining)`);
                    } else {
                        appendMessage('ai', data.response + '\n\nThat was your last free query! Sign up to continue.');
                    }
                } else {
                    appendMessage('ai', data.response);
                }

                // Hide typing indicator
                typingIndicator.style.display = 'none';

            } catch (error) {
                console.error('Error:', error);
                typingIndicator.style.display = 'none';
                appendMessage('ai', 'Connection lost. The matrix is interfering. Try again.');
            }
        });

        function appendMessage(sender, text) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message', sender);

            const strong = document.createElement('strong');
            strong.textContent = sender === 'user' ? 'You: ' : 'Coach: ';

            msgDiv.appendChild(strong);
            msgDiv.appendChild(document.createTextNode(text));

            chatHistory.appendChild(msgDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            // Save to localStorage for guest users
            const token = localStorage.getItem('access_token');
            if (!token) {
                saveGuestMessage(sender, text);
            }
        }

        // Save guest message to localStorage
        function saveGuestMessage(sender, content) {
            try {
                const guestHistory = localStorage.getItem('guest_chat_history');
                let messages = guestHistory ? JSON.parse(guestHistory) : [];

                messages.push({ sender, content });

                // Keep only last 50 messages to avoid localStorage size limits
                if (messages.length > 50) {
                    messages = messages.slice(-50);
                }

                localStorage.setItem('guest_chat_history', JSON.stringify(messages));
            } catch (error) {
                console.error('Error saving guest message:', error);
            }
        }
    </script>
</body>

</html>