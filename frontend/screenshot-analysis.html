<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RFH | Screenshot Analysis</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Roboto:wght@300;400;500&display=swap"
        rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        .upload-area {
            border: 2px dashed #333;
            border-radius: 10px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            background-color: #111;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            animation: fadeInUp 0.6s ease-out;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(208, 0, 0, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .upload-area:hover {
            border-color: #d00000;
            background-color: #1a1a1a;
        }

        .upload-area:hover::before {
            opacity: 1;
        }

        .upload-area:active {
            transform: scale(0.98);
        }

        .analysis-result {
            display: none;
            margin-top: 2rem;
            padding: 2rem;
            background-color: #111;
            border-left: 4px solid #d00000;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {

            /* Ensure all content is centered on mobile */
            .container {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }

            .row {
                margin-left: 0 !important;
                margin-right: 0 !important;
            }

            [class*="col-"] {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
            }

            .text-center,
            .col-lg-8 {
                text-align: center !important;
            }

            .upload-area {
                padding: 2rem 1rem !important;
                margin: 0 auto !important;
                border-radius: 0;
                width: 100%;
            }

            .upload-area svg {
                width: 40px !important;
                height: 40px !important;
                margin-bottom: 1rem !important;
            }

            .upload-area h4 {
                font-size: 1.1rem;
                margin-bottom: 0.5rem;
            }

            .upload-area p {
                font-size: 0.85rem;
            }

            .analysis-result {
                padding: 1.25rem !important;
                margin-top: 1.5rem !important;
                margin-left: auto !important;
                margin-right: auto !important;
                border-left-width: 3px;
            }

            .analysis-result h4 {
                font-size: 1.25rem;
                margin-bottom: 1rem !important;
            }

            .analysis-result p {
                font-size: 0.9rem;
                margin-bottom: 1rem !important;
            }

            .container.py-5 {
                padding: 2rem 1rem !important;
            }

            h1.display-4 {
                font-size: 1.75rem !important;
            }

            .lead {
                font-size: 0.95rem !important;
            }

            /* Hide footer on mobile to declutter */
            #footer-placeholder {
                display: none !important;
            }

            /* Copy button styling for mobile */
            .btn-sm.btn-outline-secondary {
                padding: 0.5rem !important;
                min-width: 40px !important;
                min-height: 40px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
            }

            .btn-sm.btn-outline-secondary svg {
                width: 18px !important;
                height: 18px !important;
            }
        }
    </style>
</head>

<body class="bg-black text-light">

    <!-- Header Component -->
    <div id="header-placeholder"></div>

    <!-- Main Content -->
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8 text-center mb-5">
                <h1 class="display-4 fw-bold text-uppercase mb-3">Decode Texts</h1>
                <p class="lead text-white-50">Upload a screenshot of your conversation. Our AI will analyze the subtext,
                    detect hidden meanings, and tell you exactly what to say next.</p>
            </div>

            <div class="col-lg-8">
                <div class="upload-area" id="uploadTrigger">
                    <div class="mb-3">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#d00000"
                            class="bi bi-cloud-upload" viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                                d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.634 14.606 11 12.75 11H3.25C1.45 11 0 9.634 0 7.773c0-1.636 1.242-2.969 2.834-3.194C3.087 3.949 3.468 3.242 4.406 1.342zM8.167 10H12.75A2.75 2.75 0 0 0 15.5 7.773c0-1.505-1.054-2.736-2.525-2.793-.196-.007-.39-.01-.586-.01H12.1c.025-.33.045-.66.05-1 .09-4.27-5.05-4.27-4.96 0-.005.335-.025.665-.05 1H6.92c-.195 0-.39.003-.586.01-1.47.057-2.525 1.288-2.525 2.793 0 1.505 1.055 2.736 2.525 2.793h4.583z" />
                            <path fill-rule="evenodd"
                                d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3z" />
                        </svg>
                    </div>
                    <h4 class="fw-bold">Click to Upload Screenshot</h4>
                    <p class="text-white-50 small">Supported formats: JPG, PNG</p>
                </div>
                <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">

                <!-- Loading State -->
                <div id="loadingState" class="text-center mt-4" style="display: none;">
                    <div class="spinner-border text-danger" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-white-50">Analyzing subtext and dynamics...</p>
                </div>

                <!-- Result Area -->
                <div id="resultArea" class="analysis-result">
                    <h4 class="text-danger fw-bold mb-3">Analysis Complete</h4>
                    <div id="analysisContent"></div>
                    <div class="mt-4 d-flex gap-2 flex-wrap">
                        <button class="btn btn-outline-light btn-sm rounded-0" onclick="analyzeAnother()">Analyze
                            Another</button>
                        <button id="clearHistoryBtn" class="btn btn-outline-danger btn-sm rounded-0"
                            onclick="clearHistory()">
                            Clear History
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Privacy Modal -->
    <div class="modal fade" id="privacyModal" tabindex="-1" aria-labelledby="privacyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary text-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title fw-bold text-danger" id="privacyModalLabel">PRIVACY WARNING</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="fw-bold">Before you proceed:</p>
                    <ul class="text-white-50 small">
                        <li class="mb-2">Please <strong>BLUR</strong> any names, phone numbers, or profile photos in
                            your screenshot.</li>
                        <li class="mb-2">We value your privacy. All images are processed in real-time and
                            <strong>IMMEDIATELY DELETED</strong> from our servers after analysis.
                        </li>
                        <li>We do not store or share your personal conversations.</li>
                    </ul>

                    <hr class="border-secondary my-3">

                    <p class="fw-bold mb-2">Help us understand the conversation:</p>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label small text-white-50">Your message color</label>
                            <input type="text" class="form-control form-control-sm bg-dark text-light border-secondary"
                                id="userColor" placeholder="e.g., blue, green" value="blue">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label small text-white-50">Their message color</label>
                            <input type="text" class="form-control form-control-sm bg-dark text-light border-secondary"
                                id="otherColor" placeholder="e.g., gray, white" value="gray">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label small text-white-50">You are</label>
                            <select class="form-select form-select-sm bg-dark text-light border-secondary"
                                id="userGender">
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label small text-white-50">They are</label>
                            <select class="form-select form-select-sm bg-dark text-light border-secondary"
                                id="otherGender">
                                <option value="female">Female</option>
                                <option value="male">Male</option>
                            </select>
                        </div>
                    </div>

                    <hr class="border-secondary my-3">

                    <p class="fw-bold mb-2">What do you want to achieve in this conversation?</p>
                    <input type="text" class="form-control form-control-sm bg-dark text-light border-secondary mb-3"
                        id="conversationGoal"
                        placeholder="e.g., Build attraction, Get a date, Re-engage after silence..."
                        value="Build attraction and romantic interest">
                    <small class="text-white-50 d-block mb-3">Be specific about your goal - the AI will tailor advice
                        accordingly</small>

                    <p class="fw-bold mb-2">Preferred tone/style for replies:</p>
                    <select class="form-select form-select-sm bg-dark text-light border-secondary mb-3" id="replyTone">
                        <option value="balanced">Balanced (Mix of styles)</option>
                        <option value="playful">Playful & Teasing</option>
                        <option value="direct">Direct & Confident</option>
                        <option value="mysterious">Mysterious & Intriguing</option>
                        <option value="casual">Casual & Friendly</option>
                        <option value="witty">Witty & Clever</option>
                        <option value="romantic">Romantic & Sweet</option>
                        <option value="cocky_funny">Cocky-Funny</option>
                        <option value="challenge">Challenge/Push-Pull</option>
                    </select>

                    <p class="fw-bold mb-2">Preferred language for replies:</p>
                    <select class="form-select form-select-sm bg-dark text-light border-secondary mb-3"
                        id="replyLanguage">
                        <option value="english">English</option>
                        <option value="hinglish">Hinglish (Hindi + English mix)</option>
                        <option value="hindi">Hindi</option>
                        <option value="spanish">Spanish</option>
                        <option value="french">French</option>
                        <option value="german">German</option>
                        <option value="italian">Italian</option>
                        <option value="portuguese">Portuguese</option>
                        <option value="russian">Russian</option>
                        <option value="japanese">Japanese</option>
                        <option value="korean">Korean</option>
                        <option value="chinese">Chinese (Simplified)</option>
                    </select>

                    <div class="form-check mt-3">
                        <input class="form-check-input bg-dark border-secondary" type="checkbox" id="privacyCheck">
                        <label class="form-check-label small" for="privacyCheck">
                            I have blurred sensitive info and understand the privacy policy.
                        </label>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-light btn-sm rounded-0"
                        data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger btn-sm rounded-0" id="confirmUpload" disabled>Select
                        Screenshot(s)</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        .hover-scale {
            transition: transform 0.2s ease;
        }

        .hover-scale:hover {
            transform: translateY(-2px);
        }
    </style>

    <!-- Guest Limit Modal -->
    <div class="modal fade" id="guestLimitModal" tabindex="-1" aria-labelledby="guestLimitModalLabel" aria-hidden="true"
        data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-black border border-secondary shadow-lg" style="border-radius: 1rem;">
                <div class="modal-body text-center p-5">
                    <div class="mb-4 position-relative d-inline-block">
                        <div class="position-absolute top-50 start-50 translate-middle"
                            style="width: 60px; height: 60px; background: rgba(220, 53, 69, 0.2); filter: blur(20px); border-radius: 50%;">
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="#dc3545"
                            class="bi bi-lock-fill position-relative z-2" viewBox="0 0 16 16">
                            <path
                                d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" />
                        </svg>
                    </div>

                    <h3 class="fw-bold text-white mb-2">Limit Reached</h3>
                    <p class="text-white-50 mb-4 px-3">You've used all 3 free analyses. Unlock unlimited access to our
                        Screenshot Analyzer to continue mastering your conversations.</p>

                    <div class="d-grid gap-3">
                        <a href="signup.html"
                            class="btn btn-danger btn-lg rounded-pill fw-bold text-uppercase shadow-sm hover-scale">
                            Unlock Unlimited Access
                        </a>
                        <a href="login.html" class="btn btn-sm rounded-pill text-white-50 border-0 hover-scale"
                            style="background: rgba(255,255,255,0.05);">
                            Already have an account? <span class="text-white fw-bold">Log In</span>
                        </a>
                    </div>
                </div>
                <!-- Close button positioned absolutely -->
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3"
                    data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer" style="z-index: 1100;"></div>

    <!-- Footer Component - Removed for cleaner UI
    <div id="footer-placeholder"></div> -->

    <script src="js/components.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/navbar.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/config.js"></script>
    <script>
        const uploadTrigger = document.getElementById('uploadTrigger');
        const fileInput = document.getElementById('fileInput');
        const privacyModal = new bootstrap.Modal(document.getElementById('privacyModal'));
        const guestLimitModal = new bootstrap.Modal(document.getElementById('guestLimitModal'));
        const privacyCheck = document.getElementById('privacyCheck');
        const confirmUpload = document.getElementById('confirmUpload');
        const loadingState = document.getElementById('loadingState');
        const resultArea = document.getElementById('resultArea');
        const analysisContent = document.getElementById('analysisContent');
        const guestBanner = document.getElementById('guestBanner'); // Assuming this element exists in components.js or elsewhere
        const queriesRemaining = document.getElementById('queriesRemaining'); // Assuming this element exists

        // Require login - redirect if no token
        const token = localStorage.getItem('access_token');
        if (!token) {
            window.location.href = 'login.html';
            // Stop execution by not continuing (redirect will happen)
        }


        const isGuest = false; // No longer support guest mode
        let guestQueryCount = 0; // Not used anymore
        const GUEST_QUERY_LIMIT = 3;


        if (isGuest) {
            // Block access visually for guests
            uploadTrigger.innerHTML = `
                <div class="mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="#d00000" class="bi bi-lock-fill" viewBox="0 0 16 16">
                        <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
                    </svg>
                </div>
                <h4 class="fw-bold text-danger">Login Required</h4>
                <p class="text-white-50 small">Screenshot analysis is a premium feature.</p>
                <button class="btn btn-outline-danger btn-sm mt-3 fw-bold text-uppercase">Login to Unlock</button>
            `;
            // Hide guest banner as it's irrelevant now
            if (guestBanner) guestBanner.style.display = 'none';
        } else {
            // User is logged in
            if (guestBanner) guestBanner.style.display = 'none';
        }

        // Function to scroll to upload area and reset
        function analyzeAnother() {
            uploadTrigger.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Reset file input
            fileInput.value = '';
        }

        // Load saved preferences
        function loadPreferences() {
            const savedUserColor = localStorage.getItem('userColor');
            const savedOtherColor = localStorage.getItem('otherColor');
            const savedUserGender = localStorage.getItem('userGender');
            const savedOtherGender = localStorage.getItem('otherGender');
            const savedGoal = localStorage.getItem('conversationGoal');
            const savedLanguage = localStorage.getItem('replyLanguage');

            if (savedUserColor) document.getElementById('userColor').value = savedUserColor;
            if (savedOtherColor) document.getElementById('otherColor').value = savedOtherColor;
            if (savedUserGender) document.getElementById('userGender').value = savedUserGender;
            if (savedOtherGender) document.getElementById('otherGender').value = savedOtherGender;
            if (savedGoal) document.getElementById('conversationGoal').value = savedGoal;
            if (savedLanguage) document.getElementById('replyLanguage').value = savedLanguage;
        }

        // Save preferences
        function savePreferences() {
            localStorage.setItem('userColor', document.getElementById('userColor').value);
            localStorage.setItem('otherColor', document.getElementById('otherColor').value);
            localStorage.setItem('userGender', document.getElementById('userGender').value);
            localStorage.setItem('otherGender', document.getElementById('otherGender').value);
            localStorage.setItem('conversationGoal', document.getElementById('conversationGoal').value);
            localStorage.setItem('replyLanguage', document.getElementById('replyLanguage').value);
        }

        // Toast notification function
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer'); // Assuming a toastContainer exists in the HTML
            if (!toastContainer) {
                console.warn('Toast container not found. Cannot display toast.');
                return;
            }
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'error' ? 'danger' : type === 'success' ? 'success' : 'info'} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
            setTimeout(() => toast.remove(), 5000);
        }

        // Load history on page load
        async function loadAnalysisHistory() {
            try {
                let analyses = [];

                if (isGuest) {
                    // Load from localStorage for guests
                    analyses = JSON.parse(localStorage.getItem('screenshot_analyses') || '[]');
                } else {
                    // Fetch from API for logged-in users
                    const response = await fetch(`${API_BASE_URL}/screenshot-history`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    if (response.ok) {
                        analyses = await response.json();
                    }
                }

                // Display analyses
                analyses.reverse().forEach(analysis => { // Added .reverse() to match original behavior
                    displayAnalysisCard({
                        assessment: analysis.assessment,
                        reply: analysis.reply, // Keep reply for backward compatibility if needed, though replies is preferred
                        replies: analysis.replies, // Use replies if available
                        reasoning: analysis.reasoning,
                        timestamp: new Date(analysis.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
                        imageData: analysis.image_data
                    });
                });
                if (analyses.length > 0) {
                    resultArea.style.display = 'block';
                }
            } catch (error) {
                console.error('Failed to load history:', error);
            }
        }

        // Function to display an analysis card
        function displayAnalysisCard(data) {
            function formatAnalysisText(text) {
                if (!text) return '';
                return text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            }

            const timestamp = data.timestamp || new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            const analysisNumber = document.querySelectorAll('.analysis-card').length + 1;

            const newAnalysisCard = document.createElement('div');
            newAnalysisCard.className = 'analysis-card mb-5 pb-4 border-bottom border-secondary';

            let imageHTML = '';

            // Handle multiple images
            if (data.imageUrls && data.imageUrls.length > 0) {
                const imagesDisplay = data.imageUrls.map((url, idx) =>
                    `<img src="${url}" alt="Uploaded screenshot ${idx + 1}" class="img-fluid border border-secondary rounded me-2 mb-2" style="max-height: 400px; object-fit: contain;">`
                ).join('');

                imageHTML = `
                    <div class="mb-4">
                        <h5 class="text-danger fw-bold mb-3">Your Screenshot${data.imageUrls.length > 1 ? 's' : ''} (${data.imageUrls.length})</h5>
                        <div class="d-flex flex-wrap">
                            ${imagesDisplay}
                        </div>
                    </div>
                `;
            } else if (data.imageUrl) {
                imageHTML = `
                    <div class="mb-4">
                        <h5 class="text-danger fw-bold mb-3">Your Screenshot</h5>
                        <img src="${data.imageUrl}" alt="Uploaded screenshot" class="img-fluid border border-secondary rounded" style="max-height: 400px; object-fit: contain;">
                    </div>
                `;
            } else if (data.imageData) {
                imageHTML = `
                    <div class="mb-4">
                        <h5 class="text-danger fw-bold mb-3">Your Screenshot</h5>
                        <img src="data:image/jpeg;base64,${data.imageData}" alt="Uploaded screenshot" class="img-fluid border border-secondary rounded" style="max-height: 400px; object-fit: contain;">
                    </div>
                `;
            }

            // Generate Replies HTML
            let repliesHTML = '';
            let replies = [];

            // Handle different data structures (legacy vs new)
            if (data.replies && Array.isArray(data.replies)) {
                replies = data.replies;
            } else if (typeof data.reply === 'string') {
                // Try to parse if it looks like JSON array
                try {
                    if (data.reply.trim().startsWith('[')) {
                        replies = JSON.parse(data.reply);
                    } else {
                        replies = [{ type: 'Recommended', text: data.reply }];
                    }
                } catch (e) {
                    replies = [{ type: 'Recommended', text: data.reply }];
                }
            }

            // Generate HTML for replies
            if (replies.length === 0) {
                repliesHTML = '<p class="text-white-50 fst-italic">No specific replies generated. See assessment.</p>';
            } else {
                replies.forEach((reply, index) => {
                    const uniqueId = `copy-btn-${analysisNumber}-${index}`;
                    const replyText = reply.text || '';
                    const safeText = replyText.replace(/\\/g, '\\\\').replace(/'/g, "\\'");

                    repliesHTML += `
                        <div class="mb-3">
                            <span class="badge bg-danger mb-2">${reply.type || 'Option ' + (index + 1)}</span>
                            <div class="p-3 bg-dark border border-secondary rounded d-flex align-items-center justify-content-between">
                                <span class="text-white flex-grow-1" style="font-size: 1.1rem; font-family: 'Roboto', sans-serif;">"${replyText}"</span>
                                <div class="position-relative">
                                    <button class="btn btn-sm btn-outline-secondary ms-3" id="${uniqueId}" 
                                        onclick="copyToClipboard('${safeText}', '${uniqueId}')" 
                                        title="Copy to clipboard"
                                        style="width: 38px; height: 38px; padding: 0; display: inline-flex; align-items: center; justify-content: center;">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-copy" viewBox="0 0 16 16" style="display: block;">
                                            <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z"/>
                                        </svg>
                                    </button>
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success" 
                                          style="display: none; font-size: 0.6rem;" id="${uniqueId}-toast">
                                        Copied!
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            newAnalysisCard.innerHTML = `
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <h4 class="text-danger fw-bold mb-0">Analysis ${analysisNumber}</h4>
                    <span class="text-white-50 small">${timestamp}</span>
                </div>
                
                ${imageHTML}
                
                <div class="mb-4">
                    <h5 class="text-danger fw-bold mb-3">Assessment</h5>
                    <p class="text-light" style="font-size: 1rem; line-height: 1.6;">${formatAnalysisText(data.assessment)}</p>
                </div>
                
                <div class="mb-4">
                    <h5 class="text-danger fw-bold mb-3">Recommended Replies</h5>
                    ${repliesHTML}
                </div>
                
                <div class="mb-4">
                    <h5 class="text-danger fw-bold mb-3">Strategy & Reasoning</h5>
                    <p class="text-white-50" style="font-size: 0.95rem; line-height: 1.6;">${formatAnalysisText(data.reasoning)}</p>
                </div>
                
                <div class="mt-3 p-2 rounded-3" style="background-color: rgba(255, 182, 193, 0.15); border: 1px solid rgba(255, 182, 193, 0.3);">
                    <p class="mb-0" style="font-size: 0.8rem; line-height: 1.4; color: #ffb6c1;">
                        <i class="bi bi-lightbulb me-1"></i>
                        <strong>Tip:</strong> Feel free to use these replies as-is or tweak them to match your personal style and the conversation flow. The key is making it feel natural and authentic to you.
                    </p>
                </div>
                
                ${!isGuest && data.id ? `
                <!-- Follow-up section removed -->
                ` : ''}
            `;

            analysisContent.appendChild(newAnalysisCard);
        }

        // Load preferences on page load
        loadPreferences();

        // Load history when page loads
        loadAnalysisHistory();

        // Open modal on click (or redirect if guest)
        uploadTrigger.addEventListener('click', () => {
            if (isGuest) {
                window.location.href = 'login.html';
                return;
            }
            privacyModal.show();
        });

        // Enable button when checked
        privacyCheck.addEventListener('change', () => {
            confirmUpload.disabled = !privacyCheck.checked;
        });

        // Trigger file input
        confirmUpload.addEventListener('click', () => {
            confirmUpload.blur(); // Remove focus before hiding modal
            privacyModal.hide();
            fileInput.click();
        });

        // Handle file selection (supports multiple files)
        fileInput.addEventListener('change', async (e) => {
            if (e.target.files.length > 0) {
                const files = Array.from(e.target.files);
                await analyzeImage(files);
            }
        });

        async function analyzeImage(files) {
            // UI Updates - show loading above previous results
            uploadTrigger.style.display = 'none';
            loadingState.style.display = 'block';

            const formData = new FormData();

            // Add all selected files to form data
            files.forEach((file) => {
                formData.append('files', file);
            });

            // Get user preferences and save them
            const userColor = document.getElementById('userColor').value.trim() || 'blue';
            const otherColor = document.getElementById('otherColor').value.trim() || 'gray';
            const userGender = document.getElementById('userGender').value;
            const otherGender = document.getElementById('otherGender').value;
            const conversationGoal = document.getElementById('conversationGoal').value.trim() || 'General dating advice';
            const replyLanguage = document.getElementById('replyLanguage').value;
            const replyTone = document.getElementById('replyTone').value;

            // Save preferences for next time
            savePreferences();

            // Create URLs for the uploaded images to display later
            const imageUrls = files.map(file => URL.createObjectURL(file));

            try {
                let endpoint, headers;

                if (isGuest) {
                    endpoint = `${API_BASE_URL}/guest-analyze?user_color=${encodeURIComponent(userColor)}&other_color=${encodeURIComponent(otherColor)}&user_gender=${userGender}&other_gender=${otherGender}&goal=${encodeURIComponent(conversationGoal)}&language=${encodeURIComponent(replyLanguage)}&tone=${encodeURIComponent(replyTone)}`;
                    headers = {};
                } else {
                    endpoint = `${API_BASE_URL}/analyze-screenshot?user_color=${encodeURIComponent(userColor)}&other_color=${encodeURIComponent(otherColor)}&user_gender=${userGender}&other_gender=${otherGender}&goal=${encodeURIComponent(conversationGoal)}&language=${encodeURIComponent(replyLanguage)}&tone=${encodeURIComponent(replyTone)}`;
                    headers = { 'Authorization': `Bearer ${token}` };
                }

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });

                if (response.status === 401) {
                    showToast('Session expired. Please login again.', 'error');
                    localStorage.removeItem('access_token');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                    return;
                }

                if (response.status === 403) {
                    const error = await response.json();
                    showToast(error.detail, 'warning');
                    setTimeout(() => window.location.href = 'profile.html', 2000);
                    return;
                }

                if (response.status === 422) {
                    const error = await response.json();
                    console.error('Validation error:', JSON.stringify(error, null, 2));
                    const errorMsg = error.detail?.[0]?.msg || JSON.stringify(error.detail);
                    showToast(`Upload failed: ${errorMsg}`, 'error');
                    loadingState.style.display = 'none';
                    return;
                }

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // Increment guest query count
                if (isGuest) {
                    guestQueryCount++;
                    localStorage.setItem('guest_query_count', guestQueryCount.toString());
                }

                // Simulate processing delay for effect
                setTimeout(() => {
                    loadingState.style.display = 'none';
                    resultArea.style.display = 'block';

                    // Prepare analysis data
                    const analysisData = {
                        id: data.id, // Include ID for follow-up questions
                        assessment: data.assessment,
                        replies: data.replies,  // Changed from data.reply to data.replies
                        reasoning: data.reasoning,
                        timestamp: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
                        imageUrls: imageUrls,  // Support multiple images
                        imageUrl: imageUrls[0]  // Keep for backward compatibility
                    };

                    // Save to localStorage for guest users
                    if (isGuest) {
                        const guestHistory = JSON.parse(localStorage.getItem('screenshot_analyses') || '[]');
                        guestHistory.push(analysisData);
                        localStorage.setItem('screenshot_analyses', JSON.stringify(guestHistory));
                    }

                    // Display the analysis card
                    displayAnalysisCard(analysisData);

                    // Show upload trigger at the bottom for next analysis
                    uploadTrigger.style.display = 'block';

                    // Scroll to the new analysis
                    const cards = document.querySelectorAll('.analysis-card');
                    const lastCard = cards[cards.length - 1];
                    if (lastCard) {
                        lastCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }

                    // Reset file input for next upload
                    fileInput.value = '';
                }, 2000);

            } catch (error) {
                console.error('Error:', error);
                loadingState.style.display = 'none';
                uploadTrigger.style.display = 'block';
                showToast('Analysis failed. Please try again.', 'error');
            }
        }
        // Copy to clipboard function with feedback
        function copyToClipboard(text, buttonId) {
            navigator.clipboard.writeText(text).then(() => {
                const toast = document.getElementById(buttonId + '-toast');
                if (toast) {
                    toast.style.display = 'block';
                    setTimeout(() => {
                        toast.style.display = 'none';
                    }, 2000);
                }
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                showToast('Failed to copy text', 'error');
            });
        }

        // Clear history function for both guests and logged-in users
        async function clearHistory() {
            // Confirm before deleting
            if (!confirm('Are you sure you want to clear all your screenshot analysis history? This action cannot be undone.')) {
                return;
            }

            if (isGuest) {
                // Clear localStorage for guests
                try {
                    localStorage.removeItem('screenshot_analyses');

                    // Clear the UI
                    analysisContent.innerHTML = '';
                    resultArea.style.display = 'none';

                    showToast('History cleared successfully', 'success');
                } catch (error) {
                    console.error('Error clearing guest history:', error);
                    showToast('Failed to clear history. Please try again.', 'error');
                }
                return;
            }

            // For logged-in users, call API
            try {
                const response = await fetch(`${API_BASE_URL}/screenshot-history`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.status === 401) {
                    showToast('Session expired. Please login again.', 'error');
                    localStorage.removeItem('access_token');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to clear history');
                }

                const data = await response.json();

                // Clear the UI
                analysisContent.innerHTML = '';
                resultArea.style.display = 'none';

                showToast(`Successfully cleared ${data.deleted_count} analysis records`, 'success');

                // Reload after 1 second
                setTimeout(() => location.reload(), 1000);

            } catch (error) {
                console.error('Error clearing history:', error);
                showToast('Failed to clear history. Please try again.', 'error');
            }
        }

        // Send follow-up question about an analysis
        async function sendFollowup(analysisId) {
            const input = document.getElementById(`chat-input-${analysisId}`);
            const messagesContainer = document.getElementById(`chat-messages-${analysisId}`);

            const question = input.value.trim();
            if (!question) {
                showToast('Please enter a question', 'error');
                return;
            }

            // Add user message to chat
            const userMsgDiv = document.createElement('div');
            userMsgDiv.className = 'mb-2 text-end';
            userMsgDiv.innerHTML = `
                <div class="d-inline-block bg-danger text-white px-3 py-2 rounded" style="max-width: 80%;">
                    <small class="d-block text-white-50 mb-1">You</small>
                    ${question}
                </div>
            `;
            messagesContainer.appendChild(userMsgDiv);

            // Clear input
            input.value = '';

            // Show loading message
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'mb-2';
            loadingDiv.id = `loading-${analysisId}`;
            loadingDiv.innerHTML = `
                <div class="d-inline-block bg-secondary text-white px-3 py-2 rounded">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    Thinking...
                </div>
            `;
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            try {
                const response = await fetch(`${API_BASE_URL}/screenshot-analysis/${analysisId}/followup`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ question })
                });

                if (response.status === 401) {
                    showToast('Session expired. Please login again.', 'error');
                    localStorage.removeItem('access_token');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to get response');
                }

                const data = await response.json();

                // Remove loading message
                loadingDiv.remove();

                // Add AI response to chat
                const aiMsgDiv = document.createElement('div');
                aiMsgDiv.className = 'mb-2';
                aiMsgDiv.innerHTML = `
                    <div class="d-inline-block bg-dark border border-secondary text-light px-3 py-2 rounded" style="max-width: 80%;">
                        <small class="d-block text-danger mb-1 fw-bold">Dating Coach</small>
                        ${data.answer.replace(/\n/g, '<br>')}
                    </div>
                `;
                messagesContainer.appendChild(aiMsgDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

            } catch (error) {
                console.error('Error sending follow-up:', error);
                loadingDiv.remove();
                showToast('Failed to send question. Please try again.', 'error');
            }
        }
    </script>
</body>

</html>