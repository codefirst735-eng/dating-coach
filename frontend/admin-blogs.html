<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>RFH Admin | Blog Management</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        .blog-form-container {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #dc3545;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .blog-list-item {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #6c757d;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .blog-status-published {
            color: #198754;
        }

        .blog-status-draft {
            color: #ffc107;
        }

        .image-preview {
            max-width: 200px;
            max-height: 150px;
            border-radius: 5px;
            margin-top: 10px;
        }
    </style>
</head>

<body class="bg-black text-light">

    <!-- Header Component -->
    <div id="header-placeholder"></div>

    <div class="container py-5">
        <div class="row">
            <div class="col-12">
                <h1 class="display-4 fw-bold text-danger mb-4">
                    <i class="bi bi-pencil-square"></i> Blog Management
                </h1>

                <!-- Create New Blog Button -->
                <button class="btn btn-danger btn-lg mb-4" onclick="showCreateForm()">
                    <i class="bi bi-plus-circle"></i> Create New Blog
                </button>

                <!-- Blog Form (Hidden by default) -->
                <div id="blogFormContainer" class="blog-form-container" style="display: none;">
                    <h3 id="formTitle" class="text-danger mb-4">Create New Blog</h3>
                    <form id="blogForm">
                        <input type="hidden" id="blogId" value="">

                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="title" class="form-label text-white">Title *</label>
                                    <input type="text" class="form-control bg-dark text-white border-secondary" id="title" required>
                                </div>

                                <div class="mb-3">
                                    <label for="slug" class="form-label text-white">Slug (URL) *</label>
                                    <input type="text" class="form-control bg-dark text-white border-secondary" id="slug" required>
                                    <div class="form-text text-muted">Auto-generated from title, but can be customized</div>
                                </div>

                                <div class="mb-3">
                                    <label for="excerpt" class="form-label text-white">Excerpt *</label>
                                    <textarea class="form-control bg-dark text-white border-secondary" id="excerpt" rows="3" required></textarea>
                                    <div class="form-text text-muted">Brief summary for blog listings</div>
                                </div>

                                <div class="mb-3">
                                    <label for="content" class="form-label text-white">Content *</label>
                                    <textarea class="form-control bg-dark text-white border-secondary" id="content" rows="10" required></textarea>
                                    <div class="form-text text-muted">Full blog content (HTML supported)</div>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="metaTitle" class="form-label text-white">SEO Title *</label>
                                    <input type="text" class="form-control bg-dark text-white border-secondary" id="metaTitle" required>
                                </div>

                                <div class="mb-3">
                                    <label for="metaDescription" class="form-label text-white">SEO Description *</label>
                                    <textarea class="form-control bg-dark text-white border-secondary" id="metaDescription" rows="3" required></textarea>
                                </div>

                                <div class="mb-3">
                                    <label for="categories" class="form-label text-white">Categories *</label>
                                    <input type="text" class="form-control bg-dark text-white border-secondary" id="categories" required>
                                    <div class="form-text text-muted">Comma-separated categories (e.g., Dating Advice, Psychology, Relationships)</div>
                                </div>

                                <div class="mb-3">
                                    <label for="keywords" class="form-label text-white">Keywords *</label>
                                    <input type="text" class="form-control bg-dark text-white border-secondary" id="keywords" required>
                                    <div class="form-text text-muted">Comma-separated keywords for SEO</div>
                                </div>

                                <div class="mb-3">
                                    <label for="author" class="form-label text-white">Author</label>
                                    <input type="text" class="form-control bg-dark text-white border-secondary" id="author" value="RFH Team">
                                </div>

                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="published">
                                        <label class="form-check-label text-white" for="published">
                                            Publish immediately
                                        </label>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="featuredImage" class="form-label text-white">Featured Image</label>
                                    <input type="file" class="form-control bg-dark text-white border-secondary" id="featuredImage" accept="image/*">
                                    <div id="imagePreview" class="mt-2"></div>
                                    <input type="hidden" id="featuredImageUrl" value="">
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-danger">
                                <i class="bi bi-check-circle"></i> Save Blog
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="hideCreateForm()">
                                <i class="bi bi-x-circle"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Blog List -->
                <div id="blogList">
                    <h3 class="text-white mb-4">All Blogs</h3>
                    <div id="blogsContainer">
                        <!-- Blogs will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Component -->
    <div id="footer-placeholder"></div>

    <script src="js/components.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/navbar.js"></script>
    <script src="js/config.js"></script>

    <script>
        let allBlogs = [];

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadBlogs();
        });

        // Generate slug from title
        document.getElementById('title').addEventListener('input', function() {
            if (!document.getElementById('blogId').value) { // Only auto-generate for new blogs
                const title = this.value;
                const slug = title.toLowerCase()
                    .replace(/[^\w\s-]/g, '') // Remove special characters
                    .replace(/[\s_-]+/g, '-') // Replace spaces and underscores with hyphens
                    .replace(/^-+|-+$/g, ''); // Remove leading/trailing hyphens
                document.getElementById('slug').value = slug;
            }
        });

        // Handle image upload
        document.getElementById('featuredImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('file', file);

                fetch(`${API_BASE_URL}/admin/upload-blog-image`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.url) {
                        document.getElementById('featuredImageUrl').value = data.filename;
                        showImagePreview(data.url);
                        showToast('Image uploaded successfully!', 'success');
                    } else {
                        showToast('Error uploading image', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error uploading image', 'error');
                });
            }
        });

        // Show image preview
        function showImagePreview(imageUrl) {
            const preview = document.getElementById('imagePreview');
            preview.innerHTML = `<img src="${API_BASE_URL}/uploads/blogs/${imageUrl}" class="image-preview" alt="Preview">`;
        }

        // Load all blogs
        function loadBlogs() {
            fetch(`${API_BASE_URL}/admin/blogs`)
                .then(response => response.json())
                .then(data => {
                    allBlogs = data.blogs || [];
                    displayBlogs(allBlogs);
                })
                .catch(error => {
                    console.error('Error loading blogs:', error);
                    showToast('Error loading blogs', 'error');
                });
        }

        // Display blogs in the list
        function displayBlogs(blogs) {
            const container = document.getElementById('blogsContainer');
            if (blogs.length === 0) {
                container.innerHTML = '<p class="text-muted">No blogs found. Create your first blog!</p>';
                return;
            }

            container.innerHTML = blogs.map(blog => `
                <div class="blog-list-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h5 class="text-white mb-1">${blog.title}</h5>
                            <p class="text-muted small mb-2">Slug: ${blog.slug}</p>
                            <p class="text-white-50 small">${blog.excerpt}</p>
                            <div class="d-flex gap-2 mt-2">
                                <span class="badge ${blog.published ? 'bg-success' : 'bg-warning'}">
                                    ${blog.published ? 'Published' : 'Draft'}
                                </span>
                                <small class="text-muted">Created: ${new Date(blog.created_at).toLocaleDateString()}</small>
                            </div>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="editBlog(${blog.id})">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteBlog(${blog.id})">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Show create form
        function showCreateForm() {
            document.getElementById('blogFormContainer').style.display = 'block';
            document.getElementById('formTitle').textContent = 'Create New Blog';
            document.getElementById('blogForm').reset();
            document.getElementById('blogId').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('featuredImageUrl').value = '';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Hide create form
        function hideCreateForm() {
            document.getElementById('blogFormContainer').style.display = 'none';
        }

        // Edit blog
        function editBlog(blogId) {
            const blog = allBlogs.find(b => b.id === blogId);
            if (!blog) return;

            document.getElementById('blogId').value = blog.id;
            document.getElementById('title').value = blog.title;
            document.getElementById('slug').value = blog.slug;
            document.getElementById('excerpt').value = blog.excerpt;
            document.getElementById('content').value = blog.content;
            document.getElementById('categories').value = blog.categories || '';
            document.getElementById('metaTitle').value = blog.meta_title;
            document.getElementById('metaDescription').value = blog.meta_description;
            document.getElementById('keywords').value = blog.keywords;
            document.getElementById('author').value = blog.author;
            document.getElementById('published').checked = blog.published;

            if (blog.featured_image) {
                document.getElementById('featuredImageUrl').value = blog.featured_image;
                showImagePreview(blog.featured_image);
            }

            document.getElementById('formTitle').textContent = 'Edit Blog';
            document.getElementById('blogFormContainer').style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Delete blog
        function deleteBlog(blogId) {
            if (!confirm('Are you sure you want to delete this blog? This action cannot be undone.')) {
                return;
            }

            fetch(`${API_BASE_URL}/admin/blogs/${blogId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                showToast('Blog deleted successfully!', 'success');
                loadBlogs();
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error deleting blog', 'error');
            });
        }

        // Handle form submission
        document.getElementById('blogForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const blogId = document.getElementById('blogId').value;
            const blogData = {
                title: document.getElementById('title').value,
                slug: document.getElementById('slug').value,
                excerpt: document.getElementById('excerpt').value,
                content: document.getElementById('content').value,
                categories: document.getElementById('categories').value,
                meta_title: document.getElementById('metaTitle').value,
                meta_description: document.getElementById('metaDescription').value,
                keywords: document.getElementById('keywords').value,
                author: document.getElementById('author').value,
                published: document.getElementById('published').checked
            };

            const featuredImage = document.getElementById('featuredImageUrl').value;
            if (featuredImage) {
                blogData.featured_image = featuredImage;
            }

            const url = blogId ? `${API_BASE_URL}/admin/blogs/${blogId}` : `${API_BASE_URL}/admin/blogs`;
            const method = blogId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(blogData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.id || data.title) {
                    const message = blogId ? 'Blog updated successfully!' : 'Blog created successfully!';
                    showToast(message, 'success');
                    hideCreateForm();
                    loadBlogs();
                } else {
                    showToast('Error saving blog', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error saving blog', 'error');
            });
        });

        // Toast notification function
        function showToast(message, type = 'info') {
            // Create toast container if it doesn't exist
            let toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                document.body.appendChild(toastContainer);
            }

            const toastId = 'toast-' + Date.now();
            const toastHTML = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement);
            toast.show();

            // Remove toast after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }
    </script>

</body>

</html>
